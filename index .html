<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯æŠ¥ä»·ç³»ç»Ÿ (Firebaseç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œç®€æ´ç¾è§‚ */
        :root { --primary-color: #2563eb; --sidebar-bg: #1e293b; --text-light: #f8fafc; --bg-color: #f1f5f9; --border-color: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg-color); color: #334155; }
        .sidebar { width: 250px; background-color: var(--sidebar-bg); color: var(--text-light); display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .brand-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; text-align: center; letter-spacing: 1px; }
        .nav-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.3s; font-size: 14px; }
        .nav-btn:hover { background: var(--primary-color); }
        .status-indicator { margin-top: auto; font-size: 12px; color: #94a3b8; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .dot.online { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        thead { background-color: #f8fafc; border-bottom: 2px solid var(--border-color); }
        th { text-align: left; padding: 16px; font-weight: 600; color: #64748b; }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }
        .product-img-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #e2e8f0; }
        .price-badge { font-weight: bold; color: #059669; background: #ecfdf5; padding: 4px 8px; border-radius: 4px; }
        .no-price { color: #94a3b8; font-style: italic; font-size: 0.9em; }
        .action-btn { padding: 6px 12px; border: 1px solid var(--border-color); background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-right: 5px; transition: 0.2s; }
        .action-btn.view-chart { color: var(--primary-color); border-color: var(--primary-color); }
        .action-btn.view-chart:hover { background: var(--primary-color); color: white; }
        .action-btn.delete { color: #ef4444; border-color: #ef4444; }
        .action-btn.delete:hover { background: #ef4444; color: white; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        .modal-lg { width: 800px; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #94a3b8; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .btn-primary { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand-title">æŠ¥ä»·ç³»ç»Ÿ Cloud</div>
        <button class="nav-btn" onclick="openModal('addProductModal')">+ æ–°å¢äº§å“</button>
        <button class="nav-btn" onclick="openModal('addQuoteModal')">+ å½•å…¥æŠ¥ä»·</button>
        
        <div class="status-indicator">
            <div class="dot" id="connectionDot"></div>
            <span id="connectionText">è¿æ¥ä¸­...</span>
        </div>
    </aside>

    <main class="main-content">
        <div class="header-section">
            <h2>äº‘ç«¯äº§å“åˆ—è¡¨</h2>
            <div style="color: #64748b; font-size: 0.9rem;" id="currentDateDisplay"></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="80">å›¾ç‰‡</th>
                        <th>å“ç‰Œ</th>
                        <th>äº§å“åç§°</th>
                        <th>ä»Šæ—¥æŠ¥ä»·</th>
                        <th>æœ€æ–°æŠ¥ä»·æ—¥æœŸ</th>
                        <th width="200">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <tr><td colspan="6" style="text-align:center; padding:40px;">æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="addProductModal" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="closeModal('addProductModal')">&times;</span>
            <h3>æ–°å¢äº§å“</h3>
            <div class="form-group"><label>å“ç‰Œ</label><input type="text" id="newBrand"></div>
            <div class="form-group"><label>å‹å·</label><input type="text" id="newName"></div>
            <div class="form-group"><label>å›¾ç‰‡</label><input type="file" id="newImg" accept="image/*"></div>
            <button class="btn-primary" onclick="handleAddProduct()">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>

    <div id="addQuoteModal" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="closeModal('addQuoteModal')">&times;</span>
            <h3>å½•å…¥æŠ¥ä»·</h3>
            <div class="form-group"><label>é€‰æ‹©äº§å“</label><select id="quoteProductSelect"></select></div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="quoteDate"></div>
            <div class="form-group"><label>ä»·æ ¼ (CNY)</label><input type="number" id="quotePrice"></div>
            <button class="btn-primary" onclick="handleAddQuote()">ä¿å­˜æŠ¥ä»·</button>
        </div>
    </div>

    <div id="chartModal" class="modal-overlay">
        <div class="modal modal-lg">
            <span class="close-modal" onclick="closeModal('chartModal')">&times;</span>
            <h3 id="chartTitle">ä»·æ ¼èµ°åŠ¿</h3>
            <div style="height: 400px; width: 100%;"><canvas id="trendChart"></canvas></div>
        </div>
    </div>

<script>
    // ==========================================
    // âš ï¸ æ­¤å¤„å¡«å…¥ä½ çš„ Firebase é…ç½®ä¿¡æ¯ âš ï¸
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDsMAUeq9WtEQ4Ra1Rs6cFx3nRW3s-VuSU",        // æ›¿æ¢ä½ çš„
        authDomain: "csong3999-483ce.firebaseapp.com",   // æ›¿æ¢ä½ çš„
        databaseURL: "https://csong3999-483ce-default-rtdb.firebaseio.com", // æ›¿æ¢ä½ çš„ (æœ€é‡è¦)
        projectId: "csong3999-483ce",                    // æ›¿æ¢ä½ çš„
        storageBucket: "csong3999-483ce.firebasestorage.app",    // æ›¿æ¢ä½ çš„
        messagingSenderId: "986787052842",            // æ›¿æ¢ä½ çš„
        appId: "1:986787052842:web:0be03a776f2f52c9dbf253"              // æ›¿æ¢ä½ çš„
    };

    // 2. åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // å…¨å±€çŠ¶æ€
    let products = [];
    let chartInstance = null;

    // 3. æ ¸å¿ƒï¼šç›‘å¬äº‘ç«¯æ•°æ®å˜åŒ– (Realtime Database)
    // åªè¦æ•°æ®åº“å˜äº†ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°
    db.ref('products').on('value', (snapshot) => {
        const data = snapshot.val();
        // è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆFirebaseè¿”å›çš„æ˜¯å¯¹è±¡ï¼Œæˆ‘ä»¬è½¬å›æ•°ç»„æ–¹ä¾¿å¤„ç†ï¼‰
        if (data) {
            products = Object.keys(data).map(key => data[key]);
        } else {
            products = [];
        }
        
        // æ›´æ–°ç•Œé¢çŠ¶æ€
        document.getElementById('connectionDot').classList.add('online');
        document.getElementById('connectionText').innerText = "äº‘ç«¯å·²è¿æ¥";
        renderTable();
    });

    window.onload = () => {
        document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString();
        document.getElementById('quoteDate').valueAsDate = new Date();
    };

    // --- åŠŸèƒ½é€»è¾‘ ---

    function handleAddProduct() {
        const brand = document.getElementById('newBrand').value.trim();
        const name = document.getElementById('newName').value.trim();
        const fileInput = document.getElementById('newImg');
        if (!brand || !name) return alert("è¯·å¡«å†™å®Œæ•´");

        const id = Date.now().toString(); // IDä½œä¸ºå­—ç¬¦ä¸²
        const newProduct = { id: id, brand: brand, name: name, image: null, quotes: [] };

        if (fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                newProduct.image = e.target.result;
                saveToCloud(newProduct); // ä¸Šä¼ åˆ°äº‘ç«¯
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            saveToCloud(newProduct);
        }
    }

    // ä¿å­˜å•ä¸ªäº§å“åˆ°äº‘ç«¯
    function saveToCloud(product) {
        // ä½¿ç”¨ set æ–¹æ³•ï¼Œè·¯å¾„ä¸º products/ID
        db.ref('products/' + product.id).set(product)
            .then(() => {
                closeModal('addProductModal');
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('newBrand').value = '';
                document.getElementById('newName').value = '';
                document.getElementById('newImg').value = '';
            })
            .catch((error) => alert("ä¿å­˜å¤±è´¥: " + error.message));
    }

    function handleAddQuote() {
        const id = document.getElementById('quoteProductSelect').value;
        const date = document.getElementById('quoteDate').value;
        const price = parseFloat(document.getElementById('quotePrice').value);
        if (!id || !date || isNaN(price)) return alert("è¯·å¡«å†™å®Œæ•´");

        const product = products.find(p => p.id == id);
        if (product) {
            // åˆå§‹åŒ– quotes æ•°ç»„ï¼ˆå¦‚æœæ˜¯ç©ºçš„ï¼‰
            if (!product.quotes) product.quotes = [];

            const existingIndex = product.quotes.findIndex(q => q.date === date);
            if (existingIndex >= 0) {
                product.quotes[existingIndex].price = price;
            } else {
                product.quotes.push({ date, price });
            }
            // æ’åº
            product.quotes.sort((a, b) => new Date(a.date) - new Date(b.date));

            // æ›´æ–°äº‘ç«¯è¯¥äº§å“çš„ quotes å­—æ®µ
            db.ref('products/' + id + '/quotes').set(product.quotes)
                .then(() => {
                    closeModal('addQuoteModal');
                    alert("æŠ¥ä»·å·²åŒæ­¥åˆ°äº‘ç«¯");
                });
        }
    }

    function deleteProduct(id) {
        if (confirm("ç¡®å®šä»äº‘ç«¯åˆ é™¤æ­¤äº§å“å—ï¼Ÿä¸å¯æ¢å¤ã€‚")) {
            db.ref('products/' + id).remove();
        }
    }

    // æ¸²æŸ“è¡¨æ ¼ (ä¿æŒåŸé€»è¾‘)
    function renderTable() {
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';
        const select = document.getElementById('quoteProductSelect');
        select.innerHTML = '';

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px;">äº‘ç«¯æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ äº§å“</td></tr>';
            return;
        }

        const today = new Date().toISOString().split('T')[0];

        products.forEach(p => {
            // å¡«å……ä¸‹æ‹‰èœå•
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.brand} - ${p.name}`;
            select.appendChild(option);

            const quotes = p.quotes || [];
            const todayQuote = quotes.find(q => q.date === today);
            const latestQuote = quotes.length > 0 ? quotes[quotes.length - 1] : null;

            let priceDisplay = todayQuote ? `<span class="price-badge">Â¥${todayQuote.price}</span>` : '<span class="no-price">ä»Šæ—¥æœªæŠ¥</span>';
            let latestDate = latestQuote ? latestQuote.date : '-';
            const imgUrl = p.image || 'https://via.placeholder.com/50?text=NoImg';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${imgUrl}" class="product-img-thumb"></td>
                <td style="font-weight:600; color:#475569;">${p.brand}</td>
                <td>${p.name}</td>
                <td>${priceDisplay}</td>
                <td style="color:#64748b; font-size:0.9em;">${latestDate}</td>
                <td>
                    <button class="action-btn view-chart" onclick="showTrend('${p.id}')">ğŸ“ˆ è¶‹åŠ¿å›¾</button>
                    <button class="action-btn delete" onclick="deleteProduct('${p.id}')">åˆ é™¤</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showTrend(id) {
        const product = products.find(p => p.id == id); // æ³¨æ„IDç±»å‹è½¬æ¢
        if (!product) return;
        document.getElementById('chartTitle').innerText = `${product.brand} ${product.name} - ä»·æ ¼èµ°åŠ¿`;
        openModal('chartModal');
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        const quotes = product.quotes || [];
        const labels = quotes.map(q => q.date);
        const data = quotes.map(q => q.price);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å†å²æŠ¥ä»· (CNY)',
                    data: data,
                    borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2, fill: true, tension: 0.4, pointRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(event) { if (event.target.classList.contains('modal-overlay')) event.target.style.display = "none"; }
</script>
</body>
</html>