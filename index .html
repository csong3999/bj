<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯æŠ¥ä»·ç³»ç»Ÿ (Proç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary-color: #2563eb; --sidebar-bg: #1e293b; --text-light: #f8fafc; --bg-color: #f1f5f9; --border-color: #e2e8f0; --accent-color: #f59e0b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg-color); color: #334155; }
        
        /* --- ä¾§è¾¹æ å‡çº§æ ·å¼ --- */
        .sidebar { width: 250px; background-color: var(--sidebar-bg); color: var(--text-light); display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 10px rgba(0,0,0,0.1); overflow-y: auto; }
        .brand-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; text-align: center; letter-spacing: 1px; }
        
        .nav-section-title { font-size: 0.8rem; text-transform: uppercase; color: #64748b; margin-top: 20px; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }
        
        .nav-btn { background: rgba(255,255,255,0.05); color: #cbd5e1; border: none; padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: space-between; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--primary-color); color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .brand-count { font-size: 0.75em; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 10px; }

        .main-btn { background: var(--primary-color); color: white; font-weight: 600; margin-bottom: 10px; justify-content: center; }
        .main-btn:hover { background: #1d4ed8; }

        .status-indicator { margin-top: auto; padding-top: 20px; font-size: 12px; color: #94a3b8; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .dot.online { background: #22c55e; box-shadow: 0 0 5px #22c55e; }

        /* --- ä¸»ç•Œé¢æ ·å¼ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        thead { background-color: #f8fafc; border-bottom: 2px solid var(--border-color); }
        th { text-align: left; padding: 16px; font-weight: 600; color: #64748b; }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }
        .product-img-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #e2e8f0; }
        .price-badge { font-weight: bold; color: #059669; background: #ecfdf5; padding: 4px 8px; border-radius: 4px; }
        .no-price { color: #94a3b8; font-style: italic; font-size: 0.9em; }
        
        /* æŒ‰é’®ç»„æ ·å¼å‡çº§ */
        .action-btn { padding: 6px 10px; border: 1px solid var(--border-color); background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-right: 4px; transition: 0.2s; }
        
        /* âš¡ æé€ŸæŠ¥ä»·æŒ‰é’® */
        .action-btn.quick-quote { color: #d97706; border-color: #d97706; background-color: #fffbeb; font-weight: bold; }
        .action-btn.quick-quote:hover { background: #d97706; color: white; }
        
        .action-btn.view-chart { color: var(--primary-color); border-color: var(--primary-color); }
        .action-btn.view-chart:hover { background: var(--primary-color); color: white; }
        .action-btn.delete { color: #ef4444; border-color: #ef4444; }
        .action-btn.delete:hover { background: #ef4444; color: white; }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 450px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        .modal-lg { width: 800px; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #94a3b8; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .btn-primary { background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand-title">æŠ¥ä»·ç³»ç»Ÿ Cloud</div>
        
        <button class="nav-btn main-btn" onclick="openModal('addProductModal')">+ æ–°å¢äº§å“</button>
        
        <div class="nav-section-title">å“ç‰Œç­›é€‰ (Brands)</div>
        <div id="brandListContainer">
            </div>
        
        <div class="status-indicator">
            <div class="dot" id="connectionDot"></div>
            <span id="connectionText">è¿æ¥ä¸­...</span>
        </div>
    </aside>

    <main class="main-content">
        <div class="header-section">
            <h2 id="mainTitle">å…¨éƒ¨äº§å“</h2>
            <div style="color: #64748b; font-size: 0.9rem;" id="currentDateDisplay"></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="60">å›¾</th>
                        <th>å“ç‰Œ</th>
                        <th>å‹å·</th>
                        <th>ä»Šæ—¥ä»·</th>
                        <th>æ›´æ–°æ—¥æœŸ</th>
                        <th width="220">å¿«æ·æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <tr><td colspan="6" style="text-align:center; padding:40px;">æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="addProductModal" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="closeModal('addProductModal')">&times;</span>
            <h3>æ–°å¢äº§å“</h3>
            <div class="form-group"><label>å“ç‰Œ</label><input type="text" id="newBrand" placeholder="å¦‚: Apple"></div>
            <div class="form-group"><label>å‹å·</label><input type="text" id="newName" placeholder="å¦‚: iPhone 15"></div>
            <div class="form-group"><label>å›¾ç‰‡</label><input type="file" id="newImg" accept="image/*"></div>
            <button class="btn-primary" onclick="handleAddProduct()">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>

    <div id="addQuoteModal" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="closeModal('addQuoteModal')">&times;</span>
            <h3>å½•å…¥æŠ¥ä»·</h3>
            <div class="form-group"><label>äº§å“</label><select id="quoteProductSelect"></select></div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="quoteDate"></div>
            <div class="form-group">
                <label>ä»·æ ¼ (CNY)</label>
                <input type="number" id="quotePrice" placeholder="è¾“å…¥ä»·æ ¼åæŒ‰å›è½¦" onkeydown="if(event.key==='Enter') handleAddQuote()">
            </div>
            <button class="btn-primary" onclick="handleAddQuote()">ä¿å­˜æŠ¥ä»· (Enter)</button>
        </div>
    </div>

    <div id="chartModal" class="modal-overlay">
        <div class="modal modal-lg">
            <span class="close-modal" onclick="closeModal('chartModal')">&times;</span>
            <h3 id="chartTitle">ä»·æ ¼èµ°åŠ¿</h3>
            <div style="height: 400px; width: 100%;"><canvas id="trendChart"></canvas></div>
        </div>
    </div>

<script>
    // ==========================================
    // âš ï¸ è¯·åœ¨è¿™é‡Œå¡«å›ä½ åˆšæ‰çš„é…ç½®ä¿¡æ¯ âš ï¸
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDMsMAUeq9WtEQ4Ra1Rs6cFx3nRW3s-VuSU",       
        authDomain: "csong3999-483ce.firebaseapp.com",   
        databaseURL: "https://csong3999-483ce-default-rtdb.firebaseio.com", 
        projectId: "csong3999-483ce",                   
        storageBucket: "csong3999-483ce.firebasestorage.app",   
        messagingSenderId: "986787052842",            
        appId: "1:986787052842:web:0be03a776f2f52c9dbf253"             
    };

    // åˆå§‹åŒ–
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    // å…¨å±€å˜é‡
    let products = [];
    let currentFilter = 'ALL'; // å½“å‰é€‰ä¸­çš„å“ç‰Œç­›é€‰
    let chartInstance = null;

    // æ ¸å¿ƒï¼šæ•°æ®ç›‘å¬
    db.ref('products').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            products = Object.keys(data).map(key => data[key]);
            // æŒ‰å“ç‰Œæ’åº
            products.sort((a, b) => a.brand.localeCompare(b.brand));
        } else {
            products = [];
        }
        
        updateUIStatus(true);
        renderBrandSidebar(); // 1. æ›´æ–°ä¾§è¾¹æ å“ç‰Œ
        renderTable();        // 2. æ›´æ–°è¡¨æ ¼
    });

    window.onload = () => {
        document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString();
    };

    // --- åŠŸèƒ½ 1ï¼šä¾§è¾¹æ å“ç‰Œç­›é€‰ ---
    function renderBrandSidebar() {
        const container = document.getElementById('brandListContainer');
        container.innerHTML = '';

        // 1. æå–æ‰€æœ‰å”¯ä¸€å“ç‰Œå¹¶ç»Ÿè®¡æ•°é‡
        const brandStats = {};
        products.forEach(p => {
            brandStats[p.brand] = (brandStats[p.brand] || 0) + 1;
        });
        const brands = Object.keys(brandStats).sort();

        // 2. æ·»åŠ â€œå…¨éƒ¨â€æŒ‰é’®
        const allBtn = document.createElement('button');
        allBtn.className = `nav-btn ${currentFilter === 'ALL' ? 'active' : ''}`;
        allBtn.innerHTML = `<span>å…¨éƒ¨äº§å“</span> <span class="brand-count">${products.length}</span>`;
        allBtn.onclick = () => filterByBrand('ALL');
        container.appendChild(allBtn);

        // 3. æ·»åŠ å„ä¸ªå“ç‰ŒæŒ‰é’®
        brands.forEach(brand => {
            const btn = document.createElement('button');
            btn.className = `nav-btn ${currentFilter === brand ? 'active' : ''}`;
            btn.innerHTML = `<span>${brand}</span> <span class="brand-count">${brandStats[brand]}</span>`;
            btn.onclick = () => filterByBrand(brand);
            container.appendChild(btn);
        });
    }

    function filterByBrand(brand) {
        currentFilter = brand;
        document.getElementById('mainTitle').innerText = brand === 'ALL' ? 'å…¨éƒ¨äº§å“' : `${brand} äº§å“åˆ—è¡¨`;
        renderBrandSidebar(); // åˆ·æ–°é«˜äº®çŠ¶æ€
        renderTable();        // åˆ·æ–°è¡¨æ ¼æ•°æ®
    }

    // --- åŠŸèƒ½ 2ï¼šæé€ŸæŠ¥ä»· ---
    function openQuickQuote(productId) {
        // 1. æ‰“å¼€å¼¹çª—
        openModal('addQuoteModal');
        
        // 2. è‡ªåŠ¨é€‰æ‹©äº§å“
        const select = document.getElementById('quoteProductSelect');
        select.value = productId;
        
        // 3. è‡ªåŠ¨å¡«å…¥ä»Šå¤©æ—¥æœŸ
        document.getElementById('quoteDate').valueAsDate = new Date();
        
        // 4. æ¸…ç©ºä»·æ ¼å¹¶èšç„¦ (ç”¨æˆ·å¯ä»¥ç›´æ¥æ‰“å­—)
        const priceInput = document.getElementById('quotePrice');
        priceInput.value = '';
        
        // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿å¼¹çª—åŠ¨ç”»å®Œæˆ
        setTimeout(() => priceInput.focus(), 100);
    }

    // --- æ¸²æŸ“è¡¨æ ¼ ---
    function renderTable() {
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';
        
        // æ›´æ–°ä¸‹æ‹‰èœå•ï¼ˆæ— è®ºç­›é€‰å¦‚ä½•ï¼Œä¸‹æ‹‰èœå•é‡Œåº”è¯¥æœ‰æ‰€æœ‰äº§å“ï¼‰
        updateProductSelect();

        // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤æ•°æ®
        let displayProducts = products;
        if (currentFilter !== 'ALL') {
            displayProducts = products.filter(p => p.brand === currentFilter);
        }

        if (displayProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px;">æ²¡æœ‰æ‰¾åˆ°äº§å“</td></tr>';
            return;
        }

        const today = new Date().toISOString().split('T')[0];

        displayProducts.forEach(p => {
            const quotes = p.quotes || [];
            const todayQuote = quotes.find(q => q.date === today);
            const latestQuote = quotes.length > 0 ? quotes[quotes.length - 1] : null;

            let priceDisplay = todayQuote ? 
                `<span class="price-badge">Â¥${todayQuote.price}</span>` : 
                '<span class="no-price">ä»Šæ—¥æœªæŠ¥</span>';
            let latestDate = latestQuote ? latestQuote.date : '-';
            const imgUrl = p.image || 'https://via.placeholder.com/50?text=NoImg';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${imgUrl}" class="product-img-thumb"></td>
                <td style="font-weight:600; color:#475569;">${p.brand}</td>
                <td>${p.name}</td>
                <td>${priceDisplay}</td>
                <td style="color:#64748b; font-size:0.9em;">${latestDate}</td>
                <td>
                    <button class="action-btn quick-quote" onclick="openQuickQuote('${p.id}')">âš¡ æŠ¥ä»·</button>
                    <button class="action-btn view-chart" onclick="showTrend('${p.id}')">ğŸ“ˆ è¶‹åŠ¿</button>
                    <button class="action-btn delete" onclick="deleteProduct('${p.id}')">ğŸ—‘ï¸</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- æ ‡å‡†æ•°æ®æ“ä½œé€»è¾‘ ---

    function handleAddProduct() {
        const brand = document.getElementById('newBrand').value.trim();
        const name = document.getElementById('newName').value.trim();
        const fileInput = document.getElementById('newImg');
        
        if (!brand || !name) return alert("è¯·å¡«å†™å®Œæ•´");
        const id = Date.now().toString();
        const newProduct = { id, brand, name, image: null, quotes: [] };

        if (fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                newProduct.image = e.target.result;
                saveToCloud(newProduct);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            saveToCloud(newProduct);
        }
    }

    function saveToCloud(product) {
        db.ref('products/' + product.id).set(product).then(() => {
            closeModal('addProductModal');
            document.getElementById('newBrand').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newImg').value = '';
        }).catch(e => alert(e.message));
    }

    function handleAddQuote() {
        const id = document.getElementById('quoteProductSelect').value;
        const date = document.getElementById('quoteDate').value;
        const price = parseFloat(document.getElementById('quotePrice').value);
        
        if (!id || !date || isNaN(price)) return alert("è¯·å¡«å†™å®Œæ•´");

        const product = products.find(p => p.id == id);
        if (product) {
            if (!product.quotes) product.quotes = [];
            const existingIndex = product.quotes.findIndex(q => q.date === date);
            
            if (existingIndex >= 0) {
                product.quotes[existingIndex].price = price;
            } else {
                product.quotes.push({ date, price });
            }
            product.quotes.sort((a, b) => new Date(a.date) - new Date(b.date));

            db.ref('products/' + id + '/quotes').set(product.quotes).then(() => {
                closeModal('addQuoteModal');
                // ä¸å¼¹çª—æ‰“æ‰°ï¼Œæä¾›æ›´æµç•…çš„ä½“éªŒ
                // alert("æŠ¥ä»·å·²åŒæ­¥"); 
            });
        }
    }

    function deleteProduct(id) {
        if (confirm("ç¡®å®šåˆ é™¤æ­¤äº§å“å—ï¼Ÿ")) db.ref('products/' + id).remove();
    }

    // --- è¾…åŠ©å‡½æ•° ---
    function updateProductSelect() {
        const select = document.getElementById('quoteProductSelect');
        select.innerHTML = '';
        // è¿™é‡Œå§‹ç»ˆæ˜¾ç¤ºæ‰€æœ‰äº§å“ï¼Œæ–¹ä¾¿åœ¨ä»»ä½•è§†å›¾ä¸‹å½•å…¥
        products.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.brand} - ${p.name}`;
            select.appendChild(option);
        });
    }

    function updateUIStatus(isOnline) {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        if (isOnline) {
            dot.classList.add('online');
            text.innerText = "äº‘ç«¯å·²è¿æ¥";
        }
    }

    function showTrend(id) {
        const product = products.find(p => p.id == id);
        if (!product) return;
        document.getElementById('chartTitle').innerText = `${product.brand} ${product.name} - èµ°åŠ¿`;
        openModal('chartModal');
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        const quotes = product.quotes || [];
        const labels = quotes.map(q => q.date);
        const data = quotes.map(q => q.price);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ä»·æ ¼', data: data,
                    borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2, fill: true, tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = (e) => { if (e.target.classList.contains('modal-overlay')) e.target.style.display = "none"; }
</script>
</body>
</html>
